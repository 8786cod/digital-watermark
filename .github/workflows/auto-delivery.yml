name: Auto Watermark Delivery
on:
  issues:
    types: [opened]
jobs:
  deliver-verification-report:
    if: contains(github.event.issue.title, '[WATERMARK]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Generate Verification Report
        id: generate_report
        run: |
          TIMESTAMP=$(date +%s)
          REPO="${{ github.repository }}"
          WATERMARK="GH:${REPO}-${TIMESTAMP: -6}"
          HASH=$(echo -n "$WATERMARK" | md5sum | cut -d' ' -f1)
          VERIFICATION_URL="https://your-repo.netlify.app/verify?watermark=${WATERMARK}"
          REPORT_ID=$(uuidgen | cut -c1-8)
          TIMESTAMP_UTC=$(date -u +"%Y-%m-%d %H:%M:%S")
          ISSUE_NUM="${{ github.event.issue.number }}"
          cat > report.md << EOF
## Watermark Verification Report
**Report ID**: ${REPORT_ID}
**Project**: ${REPO}
**Issue Number**: #${ISSUE_NUM}
**Generated At (UTC)**: ${TIMESTAMP_UTC}

### 水印信息
- Watermark Content: \`${WATERMARK}\`
- Verification Hash: \`${HASH}\`
- Verification URL: [${VERIFICATION_URL}](${VERIFICATION_URL})
- Validity: Valid (GitHub-native watermark)

### 支持项目
这个工具完全免费开源，若对你有帮助，欢迎自愿赞助：
[GitHub Sponsors - 8786cod](https://github.com/sponsors/8786cod)
EOF
          echo "REPORT_PATH=report.md" >> $GITHUB_OUTPUT
          echo "WATERMARK=${WATERMARK}" >> $GITHUB_OUTPUT
      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('${{ steps.generate_report.outputs.REPORT_PATH }}', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: report
            });
