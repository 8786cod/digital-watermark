name: Auto Watermark Delivery
on:
  issues:
    types: [opened] # 当Issue被创建时触发工作流
jobs:
  deliver-verification-report:
    # 仅当Issue标题包含[WATERMARK]时才执行该任务
    if: contains(github.event.issue.title, '[WATERMARK]')
    runs-on: ubuntu-latest
    permissions:
      issues: write  # 允许工作流给Issue写评论
      contents: read # 允许读取仓库内容
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # 配置Python 3.11环境

      - name: Generate Verification Report
        id: generate_report # 步骤ID，用于后续获取输出变量
        run: |
          # 生成时间戳（用于创建唯一水印）
          TIMESTAMP=$(date +%s)
          # 获取当前仓库（格式：owner/repo）
          REPO="${{ github.repository }}"
          # 生成标准化水印（遵循GH:project-id格式）
          WATERMARK="GH:$REPO-${TIMESTAMP: -6}"
          # 生成水印MD5哈希（用于验证）
          HASH=$(echo -n "$WATERMARK" | md5sum | cut -d' ' -f1)
          # 验证URL（替换为你的实际Netlify地址）
          VERIFICATION_URL="https://your-repo.netlify.app/verify?watermark=$WATERMARK"
          # 生成8位唯一报告ID
          REPORT_ID=$(uuidgen | cut -c1-8)
          # 获取UTC时间戳（用于记录）
          TIMESTAMP_UTC=$(date -u +"%Y-%m-%d %H:%M:%S")
          # 获取当前Issue编号
          ISSUE_NUM="${{ github.event.issue.number }}"

          # 生成Markdown格式验证报告
          cat > report.md << EOF
## Watermark Verification Report
**Report ID**: $REPORT_ID
**Project**: $REPO
**Issue Number**: #$ISSUE_NUM
**Generated At (UTC)**: $TIMESTAMP_UTC

### 水印信息
- Watermark Content: \`$WATERMARK\`
- Verification Hash: \`$HASH\`
- Verification URL: [$VERIFICATION_URL]($VERIFICATION_URL)
- Validity: Valid (GitHub-native watermark)

### 支持项目
这个工具完全免费开源，若对你有帮助，欢迎自愿赞助：
[GitHub Sponsors - 8786cod](https://github.com/sponsors/8786cod)
EOF

          # 输出变量到GitHub Actions，供后续步骤使用
          echo "REPORT_PATH=report.md" >> $GITHUB_OUTPUT
          echo "WATERMARK=$WATERMARK" >> $GITHUB_OUTPUT

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} # 自动注入的仓库令牌，无需手动配置
          script: |
            # 读取生成的报告文件内容
            const fs = require('fs');
            const report = fs.readFileSync('${{ steps.generate_report.outputs.REPORT_PATH }}', 'utf8');
            # 给对应Issue添加评论
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: report
            });
